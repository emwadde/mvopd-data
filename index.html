<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<title>Smoothed Radar Chart</title>

	<!-- Google fonts -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300" rel='stylesheet' type='text/css'>
	<link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>

	<!-- D3.js -->
	<script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
	<script src="https://d3js.org/d3-path.v1.min.js" charset="utf-8"></script>
	<script src="radarChart.js" charset="utf-8"></script>
	<style>
		body {
			font-family: 'Open Sans', sans-serif;
			font-size: 11px;
			font-weight: 300;
			fill: #242424;
			text-align: center;
			text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
			cursor: default;
		}

		.legend {
			font-family: 'Raleway', sans-serif;
			fill: #333333;
		}

		.loading {
			display: block;
			height: 20px;
			width: 90%;
			margin: 1em auto;
		}

		#dept {
			font-size: 1.4em;
			padding: 0.4em;
		}
	</style>
</head>

<body>
	<progress class="loading"></progress>
	<select name="dept" id="dept">
		<option selected disabled value="">Choose a Department</option>
	</select>
	<div class="polarChart" style="display: inline-flex;"></div>
	<script>
		const getUnique = (value, index, self) => { return self.indexOf(value) === index }
	</script>
	<script>
		//////////////////////////////////////////////////////////////
		//////////////////////// Set-Up //////////////////////////////
		//////////////////////////////////////////////////////////////

		var margin = { top: 50, right: 80, bottom: 50, left: 80 },
			width = Math.min(700, window.innerWidth / 4) - margin.left - margin.right,
			height = Math.min(width, window.innerHeight - margin.top - margin.bottom);

		//////////////////////////////////////////////////////////////
		////////////////////////// Data //////////////////////////////
		//////////////////////////////////////////////////////////////
		const data_url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWX2zBAuC53eUqlOdDC8w7RDS5NDajWLozSQ78Ye1Jw7nWHq54o0QU0s1UNEJDYVC8mcJkjstJjRrf/pub?gid=1700202545&single=true&output=csv"

		const initApp = data => {
			// console.log(data);
			const chooser = document.querySelector("#dept");
			chooser.addEventListener("change", e => triggerChange(e))
			document.querySelector("progress").style.visibility = "hidden";

			window.__data_depts = data.map(row => row['DEPARTMENT']).filter(getUnique);
			__data_depts.forEach(dept => {
				let opt = document.createElement("option");
				opt.value = dept;
				opt.text = dept;
				chooser.add(opt)
			})
			window.__dataset = data;
		}




		d3.csv(data_url, (data) => initApp(data));

		d3.csv(data_url, d => {
			return {
				dept: d.DEPARTMENT,
				month_num: parseInt(d.MONTH_M),
				month_name: d.MONTH_MMM,
				male: parseInt(d.MALE),
				female: parseInt(d.FEMALE)

			};
		}, (error, data) => {
			initApp(data);
		});

		let triggerChange = e => {
			console.log(e);
			let dept = e.target.value;
			let data = __dataset.filter(row => row.dept == dept);
			plotChart(dept, data)
		}

		let plotChart = (title, data) => {
			console.log(data)
			let structuredData = [
				{
					name: "Male",
					axes: data.map(row => {
						return {
							axis: row.month_name,
							value: parseInt(row.male)
						}
					})
				},
				{
					name: "Female",
					axes: data.map(row => {
						return {
							axis: row.month_name,
							value: parseInt(row.female)
						}
					})
				}
			]
			console.log("structuredData", structuredData)
			var radarChartOptions = {
				w: 290,
				h: 350,
				margin: margin,
				maxValue: 60,
				levels: 6,
				roundStrokes: false,
				color: d3.scaleOrdinal().range(["#AFC52F", "#ff6600"]),
				format: '.0f',
				legend: { title: title, translateX: 100, translateY: 40 },
				opacityCircles: 0.1,

			};

			let chart1 = RadarChart(".polarChart", structuredData, radarChartOptions);
		}

		var data0 = [
			{
				name: 'Allocated budget',
				axes: [
					{ axis: 'Sales', value: 42 },
					{ axis: 'Marketing', value: 20 },
					{ axis: 'Development', value: 60 },
					{ axis: 'Customer Support', value: 26 },
					{ axis: 'Information Technology', value: 35 },
					{ axis: 'Administration', value: 20 }
				],
				color: '#26AF32'
			},
			{
				name: 'Actual Spending',
				axes: [
					{ axis: 'Sales', value: 50 },
					{ axis: 'Marketing', value: 45 },
					{ axis: 'Development', value: 20 },
					{ axis: 'Customer Support', value: 20 },
					{ axis: 'Information Technology', value: 25 },
					{ axis: 'Administration', value: 23 }
				],
				color: '#762712'
			}
		];



		// Draw the chart, get a reference the created svg element
		// let chart1 = RadarChart(".polarChart", data, radarChartOptions);
	</script>
</body>

</html>